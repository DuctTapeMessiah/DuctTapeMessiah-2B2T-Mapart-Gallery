<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DuctTapeMessiah — 2B2T Gallery</title>
    <link rel="canonical" href="https://ducttapemessiah.art"/>
    <style>
        :root {
            --bg: #0b0b0d;
            --panel: #0f1113;
            --muted: #94a3b8;
            --accent: #b6c7d6;
            --glass: rgba(255,255,255,.035);
            --overlay-glass: rgba(15,17,19,.85);
            --shadow: 0 10px 30px rgba(0,0,0,.65);
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        }
        html, body { margin:0; background: linear-gradient(180deg, var(--bg), #050506 120%); color:#e6eef6; }
        .wrap { max-width:1200px; margin:28px auto; padding:18px; }
        header { display:flex; align-items:center; gap:18px; margin-bottom:18px; }
        .logo { width:72px; height:72px; border-radius:12px; overflow:hidden; }
        .logo img { width:100%; height:100%; object-fit:cover; }
        .title-wrap { display:flex; flex-direction:column; }
        .title-main { font-size:26px; font-weight:800; line-height:1.1; }
        .title-sub { font-size:15px; color:var(--muted); font-weight:500; }
        .controls { display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap; margin-bottom:10px; }
        .controls-left { display:flex; flex-direction:column; gap:8px; }
        .tabs { display:flex; gap:8px; }
        .tab-btn, .sort-btn { background: var(--panel); border:1px solid rgba(255,255,255,.08); padding:9px 14px; border-radius:10px; color:inherit; font-size:14px; cursor:pointer; transition:.12s; }
        .tab-btn.active, .sort-btn.active { background: var(--accent); color:#000; font-weight:700; }
        .contact { font-size:12px; color:var(--muted); }
        .contact a { color:var(--accent); text-decoration:none; }
        .sort-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; min-width:280px; }
        .search-input { background: var(--panel); border:1px solid rgba(255,255,255,.05); padding:9px 14px; border-radius:10px; color:inherit; font-size:14px; min-width:220px; }
        .grid { display:grid; grid-auto-flow:dense; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:16px; margin-top:16px; padding-top:100px; }
        .card { background:var(--glass); border-radius:12px; overflow:hidden; box-shadow:var(--shadow); transition: transform .15s; display:flex; flex-direction:column; }
        .card:hover { transform:translateY(-6px); }
        .thumb-wrapper { position:relative; width:100%; aspect-ratio:1/1; overflow:hidden; background:#000; border-radius:8px; }
        .thumb { width:100%; height:100%; object-fit:contain; object-position:center; image-rendering:pixelated; cursor:pointer; transition:transform .2s; background:#111; }
        .thumb:hover { transform: scale(1.04); }
        .meta { padding:8px 10px; display:flex; flex-direction:column; gap:6px; text-align:center; }
        .thumb-preview { position:fixed; top:5vh; right:5vw; width:35vw; height:35vw; max-width:450px; max-height:450px; border:3px solid var(--accent); border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.8); pointer-events:none; z-index:999; opacity:0; transition:opacity .25s; background:#000; image-rendering:pixelated; object-fit:contain; object-position:center; }
        .thumb-preview.visible { opacity:1; }
        @media (hover:none),(pointer:coarse){ .thumb-preview{display:none!important;} .thumb:hover{transform:none;} }

        .modal { position:fixed; inset:0; background:rgba(3,6,10,.94); display:flex; flex-direction:column; z-index:80; opacity:0; pointer-events:none; transition:.25s; }
        .modal.open { opacity:1; pointer-events:auto; }

        .modal-top-overlay {
            background:var(--overlay-glass);
            backdrop-filter:blur(12px);
            padding:10px 20px;
            text-align:center;
            color:#fff;
            box-shadow:0 8px 30px rgba(0,0,0,.6);
            max-width:90%;
            margin:16px auto 0;
            border-radius:16px;
            font-size:14px;
            word-wrap:break-word;
            overflow-wrap:break-word;
        }
        .modal-top-overlay strong { font-size:18px; display:block; margin-bottom:4px; }
        .modal-top-overlay .date { color:var(--muted); font-size:13px; margin:6px 0; }
        .modal-top-overlay .desc { font-size:14px; line-height:1.5; margin-top:12px; }
        .modal-top-overlay .credit { font-size:12px; color:var(--accent); margin-top:8px; }
        .modal-top-overlay .details-btn {
            margin-top:12px;
            padding:6px 14px;
            background:var(--panel);
            border:none;
            border-radius:8px;
            color:inherit;
            font-size:13px;
            cursor:pointer;
        }

        .modal-viewport {
            flex:1;
            background:#000;
            position:relative;
            overflow:hidden;
            display:flex;
            align-items:center;
            justify-content:center;
            touch-action:none;
            cursor:move;
            padding:3%;
            box-sizing:border-box;
        }
        .modal-img {
            image-rendering:pixelated;
            user-select:none;
            pointer-events:none;
            transition:none;
            transform-origin: center center;
            max-width:100%;
            max-height:100%;
        }

        .nav-arrow {
            position:absolute;
            top:50%;
            transform:translateY(-50%);
            width:50px;
            height:80px;
            background:rgba(0,0,0,.5);
            border-radius:8px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:32px;
            color:#fff;
            cursor:pointer;
            z-index:15;
            opacity:0;
            transition:opacity .3s;
            backdrop-filter:blur(4px);
        }
        .nav-arrow.visible { opacity:0.4; }
        .nav-arrow:hover { opacity:0.7; background:rgba(0,0,0,.7); }
        .nav-arrow.prev { left:20px; }
        .nav-arrow.next { right:20px; }

        .close-x {
            position:absolute;
            top:16px;
            right:18px;
            font-size:22px;
            background:var(--panel);
            padding:8px 12px;
            border-radius:10px;
            cursor:pointer;
            z-index:20;
        }

        .modal-controls {
            background:var(--overlay-glass);
            backdrop-filter:blur(12px);
            border-radius:12px;
            padding:12px 16px;
            margin:0 auto 16px;
            display:flex;
            flex-direction:column;
            gap:8px;
            max-width:400px;
            width:fit-content;
            font-size:11px;
            z-index:10;
        }
        .slider-row {
            display:flex;
            align-items:center;
            gap:8px;
            font-size:12px;
            color:#e6eef6;
        }
        .slider-row input[type="range"] {
            flex:1;
            height:6px;
            -webkit-appearance:none;
            background: rgba(255,255,255,0.15);
            border-radius:4px;
        }
        .slider-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance:none;
            width:14px;
            height:14px;
            background:var(--accent);
            border-radius:50%;
            cursor:pointer;
        }
        .slider-label { width:42px; font-size:11px; }
        .slider-row button {
            padding:6px 12px;
            font-size:12px;
            background:var(--panel);
            border:none;
            border-radius:8px;
            cursor:pointer;
        }

        @media (max-width:768px) {
            .slider-row { flex-direction:column; align-items:stretch; }
            .slider-row button { font-size:14px; padding:10px; }
        }
    </style>
</head>
<body>
<div class="wrap">
    <header>
        <div class="logo"><img src="images/DTM.png" alt="Logo"></div>
        <div class="title-wrap"><div class="title-main">DuctTapeMessiah</div><div class="title-sub">2B2T Gallery</div></div>
    </header>

    <div class="controls">
        <div class="controls-left">
            <div class="tabs">
                <button id="tabMapart" class="tab-btn active">My Mapart</button>
                <button id="tabScreens" class="tab-btn">Screenshots</button>
            </div>
            <div class="contact">Discord: <a href="https://discord.com/users/" target="_blank">DuctTapeMessiah</a></div>
        </div>

        <div class="sort-grid">
            <button class="sort-btn" data-sort="date-desc">Newest</button>
            <button class="sort-btn" data-sort="size-desc" id="sortLarge">Largest</button>
            <button class="sort-btn" data-sort="date-asc">Oldest</button>
            <button class="sort-btn" data-sort="size-asc" id="sortSmall">Smallest</button>
        </div>

        <input id="search" class="search-input" placeholder="Search...">
    </div>

    <div id="gallery" class="grid"></div>
</div>

<img id="hoverPreview" class="thumb-preview" alt="Preview">

<div id="modal" class="modal">
    <div class="close-x" id="modalClose">×</div>
    <div class="modal-top-overlay" id="modalOverlay"></div>

    <div class="modal-viewport" id="modalViewport">
        <img id="modalImg" class="modal-img" alt="Full view">
        <div class="nav-arrow prev" id="prevBtn">‹</div>
        <div class="nav-arrow next" id="nextBtn">›</div>
    </div>

    <div class="modal-controls" id="modalControls">
        <div class="slider-row"><button id="resetViewBtn">Reset View</button></div>
        <div class="slider-row"><span class="slider-label">Zoom</span><input id="zoomSlider" type="range" min="0.1" max="10" step="0.01" value="1"></div>
        <div class="slider-row"><span class="slider-label">Pan X</span><input id="panXSlider" type="range" min="-1" max="1" step="0.001" value="0"></div>
        <div class="slider-row"><span class="slider-label">Pan Y</span><input id="panYSlider" type="range" min="-1" max="1" step="0.001" value="0"></div>
    </div>
</div>

<script>
    const gallery = document.getElementById('gallery');
    const hover = document.getElementById('hoverPreview');
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalViewport = document.getElementById('modalViewport');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const resetBtn = document.getElementById('resetViewBtn');
    const zoomSlider = document.getElementById('zoomSlider');
    const panXSlider = document.getElementById('panXSlider');
    const panYSlider = document.getElementById('panYSlider');

    let mode = 'mapart';
    let sort = 'date-desc';
    let DATA = [], SCREENSHOTS = [], items = [], currentIndex = -1;
    let detailsShown = false;
    const isTouchDevice = /Mobi|Android/i.test(navigator.userAgent);

    let state = {
        scale: 1,
        offsetX: 0,
        offsetY: 0,
        startX: 0,
        startY: 0,
        startOffsetX: 0,
        startOffsetY: 0,
        isPanning: false
    };

    async function loadJSON(u){ try{ const r = await fetch(u); return r.ok? await r.json():[] } catch { return [] } }

    async function boot() {
        DATA = await loadJSON('maps.json');
        SCREENSHOTS = await loadJSON('screenshots.json');

        await Promise.all(DATA.map(m => new Promise(resolve=>{
            const img = new Image();
            img.src = m.image;
            img.onload = ()=>{ m.pixelWidth=img.naturalWidth; m.pixelHeight=img.naturalHeight; m.w=Math.round(img.naturalWidth/128); m.h=Math.round(img.naturalHeight/128); m.totalMaps=m.w*m.h; resolve(); };
            img.onerror=()=>{ m.totalMaps=0; resolve(); };
        })));

        document.querySelector('[data-sort="date-desc"]').classList.add('active');
        render();
    }

    function extractDateFromFilename(filename) {
        const match = filename.match(/(\d{4}-\d{2}-\d{2})/);
        return match ? match[1] : null;
    }

    function applySort(arr){
        if(sort.startsWith('date')){
            arr.sort((a,b)=>{
                let da = a.date || a.dateBuilt || extractDateFromFilename(a.image) || '0';
                let db = b.date || b.dateBuilt || extractDateFromFilename(b.image) || '0';
                da = new Date(da);
                db = new Date(db);
                return sort==='date-desc' ? db-da : da-db;
            });
        }
        else if(mode==='mapart'){
            arr.sort((a,b)=>{ const aSize=a.totalMaps||0,bSize=b.totalMaps||0; return sort==='size-desc'? bSize-aSize:aSize-bSize; });
        }
    }

    function render(){
        gallery.innerHTML='';
        const q=document.getElementById('search').value.toLowerCase();
        const allItems=mode==='mapart'?DATA:SCREENSHOTS;
        items=allItems.filter(i=>!q|| (i.title||'').toLowerCase().includes(q));
        applySort(items);

        document.getElementById('sortLarge').style.display=mode==='mapart'? '':'none';
        document.getElementById('sortSmall').style.display=mode==='mapart'? '':'none';

        items.forEach((m,idx)=>{
            const c=document.createElement('div'); c.className='card';
            const w=document.createElement('div'); w.className='thumb-wrapper';
            if(mode==='mapart' && m.w && m.h){
                let ratio=m.w/m.h, spanX=Math.min(m.w,4), spanY=Math.min(m.h,4);
                if(ratio>3) spanX=Math.min(m.w,6), spanY=1;
                if(ratio<1/3) spanX=1, spanY=Math.min(m.h,6);
                w.style.gridColumnEnd=`span ${spanX}`;
                w.style.gridRowEnd=`span ${spanY}`;
            }
            const i=document.createElement('img'); i.className='thumb'; i.src=m.thumb||m.image; i.loading='lazy'; i.alt=m.title||'Thumbnail';
            if(!isTouchDevice){
                i.onmouseenter=()=>{ hover.src=m.image; hover.classList.add('visible'); };
                i.onmouseleave=()=> hover.classList.remove('visible');
            }
            i.onclick=()=>openModal(idx);
            w.appendChild(i); c.appendChild(w);

            const meta=document.createElement('div'); meta.className='meta';
            if(mode==='mapart'){
                const maps=m.totalMaps??'?';
                meta.innerHTML=`<div class="title">${m.title||''}</div><div class="maps-tag"><div style="font-size:11px;opacity:.75;">Total Maps</div><div style="font-size:14px;font-weight:800;">${maps}</div></div>`;
            }
            else{
                meta.innerHTML=`<div class="title">${m.title||''}</div>`;
            }
            c.appendChild(meta); gallery.appendChild(c);
        });
    }

    function buildOverlayContent(showDetails = false) {
        const m = items[currentIndex];
        if (!m) return '&nbsp;';

        let html = '';
        if (m.title) html += `<strong>${m.title}</strong>`;
        let dateStr = m.date || m.dateBuilt || extractDateFromFilename(m.image);
        if (dateStr) html += `<div class="date">${dateStr}</div>`;

        if (showDetails) {
            if (m.description || m.desc) {
                html += `<div class="desc">${m.description || m.desc || ''}</div>`;
            }
            if (m.artistCredit) {
                html += `<div class="credit">Artist: ${m.artistCredit}</div>`;
            }
            html += `<button class="details-btn" id="hideDetailsBtn">Hide Details</button>`;
        } else {
            if (m.description || m.desc || m.artistCredit) {
                html += `<button class="details-btn" id="viewDetailsBtn">View Details</button>`;
            }
        }

        return html || '&nbsp;';
    }

    function openModal(idx){
        currentIndex = idx;
        const m = items[idx];
        if (!m) return;

        modal.classList.add('open');
        document.body.style.overflow='hidden';
        modalImg.src = m.image;

        detailsShown = false;
        modalOverlay.innerHTML = buildOverlayContent(false);

        prevBtn.style.display = idx > 0 ? 'flex' : 'none';
        nextBtn.style.display = idx < items.length-1 ? 'flex' : 'none';

        prevBtn.classList.add('visible');
        nextBtn.classList.add('visible');

        state = {scale:1, offsetX:0, offsetY:0, isPanning:false};
        fitView();
    }

    function fitView(){
        if (!modalImg.naturalWidth || !modalImg.naturalHeight) return;

        const vpW = modalViewport.clientWidth;
        const vpH = modalViewport.clientHeight;
        const imgW = modalImg.naturalWidth;
        const imgH = modalImg.naturalHeight;

        const scale = Math.min(vpW / imgW, vpH / imgH) * 0.97;
        state.scale = scale;
        state.offsetX = 0;
        state.offsetY = 0;
        updateTransform();
        syncSliders();
    }

    function resetView(){
        state.scale = 1;
        state.offsetX = 0;
        state.offsetY = 0;
        updateTransform();
        syncSliders();
    }

    function syncSliders(){
        zoomSlider.value = state.scale;

        const scaledW = state.scale * modalImg.naturalWidth;
        const scaledH = state.scale * modalImg.naturalHeight;
        const maxPanX = Math.max(0, (scaledW - modalViewport.clientWidth) / 2);
        const maxPanY = Math.max(0, (scaledH - modalViewport.clientHeight) / 2);

        const normX = maxPanX !== 0 ? state.offsetX / maxPanX : 0;
        const normY = maxPanY !== 0 ? state.offsetY / maxPanY : 0;

        panXSlider.value = normX;
        panYSlider.value = normY;
    }

    function updateTransform(){
        modalImg.style.transform = `translate(${state.offsetX}px, ${state.offsetY}px) scale(${state.scale})`;
    }

    function clampPan(){
        const scaledW = state.scale * modalImg.naturalWidth;
        const scaledH = state.scale * modalImg.naturalHeight;
        const maxPanX = Math.max(0, (scaledW - modalViewport.clientWidth) / 2);
        const maxPanY = Math.max(0, (scaledH - modalViewport.clientHeight) / 2);

        state.offsetX = Math.max(-maxPanX, Math.min(maxPanX, state.offsetX));
        state.offsetY = Math.max(-maxPanY, Math.min(maxPanY, state.offsetY));
    }

    zoomSlider.oninput = () => {
        state.scale = parseFloat(zoomSlider.value);
        clampPan();
        updateTransform();
    };
    panXSlider.oninput = () => {
        const scaledW = state.scale * modalImg.naturalWidth;
        const maxPanX = Math.max(0, (scaledW - modalViewport.clientWidth) / 2);
        state.offsetX = parseFloat(panXSlider.value) * maxPanX;
        updateTransform();
    };
    panYSlider.oninput = () => {
        const scaledH = state.scale * modalImg.naturalHeight;
        const maxPanY = Math.max(0, (scaledH - modalViewport.clientHeight) / 2);
        state.offsetY = parseFloat(panYSlider.value) * maxPanY;
        updateTransform();
    };

    resetBtn.onclick = resetView;

    modalOverlay.addEventListener('click', (e) => {
        if (e.target.id === 'viewDetailsBtn') {
            detailsShown = true;
            modalOverlay.innerHTML = buildOverlayContent(true);
        } else if (e.target.id === 'hideDetailsBtn') {
            detailsShown = false;
            modalOverlay.innerHTML = buildOverlayContent(false);
        }
    });

    function showUIElements() {
        prevBtn.classList.add('visible');
        nextBtn.classList.add('visible');
    }

    function navigate(delta){
        const newIdx = currentIndex + delta;
        if(newIdx >= 0 && newIdx < items.length) openModal(newIdx);
    }
    prevBtn.onclick = () => { navigate(-1); showUIElements(); };
    nextBtn.onclick = () => { navigate(1); showUIElements(); };

    document.addEventListener('keydown', e=>{
        if(!modal.classList.contains('open')) return;
        if(e.key==='ArrowLeft'){ navigate(-1); showUIElements(); }
        if(e.key==='ArrowRight'){ navigate(1); showUIElements(); }
        if(e.key==='Escape') closeModal();
    });

    modalViewport.addEventListener('mousedown', e=>{
        if(isTouchDevice) return;
        state.isPanning = true;
        state.startX = e.clientX;
        state.startY = e.clientY;
        state.startOffsetX = state.offsetX;
        state.startOffsetY = state.offsetY;
        modalViewport.style.cursor = 'grabbing';
    });
    document.addEventListener('mousemove', e=>{
        if(!state.isPanning) return;
        const dx = e.clientX - state.startX;
        const dy = e.clientY - state.startY;
        state.offsetX = state.startOffsetX + dx;
        state.offsetY = state.startOffsetY + dy;
        clampPan();
        updateTransform();
        syncSliders();
        showUIElements();
    });
    document.addEventListener('mouseup', ()=>{
        if(state.isPanning){
            state.isPanning = false;
            modalViewport.style.cursor = 'move';
        }
    });

    let lastTouchDistance = null;
    modalViewport.addEventListener('touchstart', e=>{
        showUIElements();
        if(e.touches.length === 2){
            lastTouchDistance = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            state.startScale = state.scale;
        } else if(e.touches.length === 1){
            state.startX = e.touches[0].clientX;
            state.startY = e.touches[0].clientY;
            state.startOffsetX = state.offsetX;
            state.startOffsetY = state.offsetY;
        }
    }, {passive: true});

    modalViewport.addEventListener('touchmove', e=>{
        if(e.touches.length === 2){
            const dist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            state.scale = state.startScale * (dist / lastTouchDistance);
            clampPan();
            updateTransform();
            syncSliders();
        } else if(e.touches.length === 1){
            const dx = e.touches[0].clientX - state.startX;
            const dy = e.touches[0].clientY - state.startY;
            state.offsetX = state.startOffsetX + dx;
            state.offsetY = state.startOffsetY + dy;
            clampPan();
            updateTransform();
            syncSliders();
        }
    }, {passive: false});

    modalViewport.addEventListener('mousemove', showUIElements);
    modalViewport.addEventListener('touchstart', showUIElements, {passive: true});

    modal.onclick = e => { if(e.target === modal) closeModal(); };
    document.getElementById('modalClose').onclick = closeModal;

    function closeModal(){
        modal.classList.remove('open');
        document.body.style.overflow='';
        currentIndex = -1;
    }

    document.getElementById('tabMapart').onclick=()=>{ mode='mapart'; document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active')); document.getElementById('tabMapart').classList.add('active'); render(); };
    document.getElementById('tabScreens').onclick=()=>{ mode='screens'; document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active')); document.getElementById('tabScreens').classList.add('active'); render(); };
    document.getElementById('search').oninput=()=>setTimeout(render,150);
    document.querySelectorAll('.sort-btn').forEach(b=>{ b.onclick=()=>{ sort=b.dataset.sort; document.querySelectorAll('.sort-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); render(); }});

    modalImg.onload = () => { fitView(); };

    boot();
</script>
</body>
</html>